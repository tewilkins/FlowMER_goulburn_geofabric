---
title: "Extracting stream and catchment geometry data for the Goulburn River"
author: "Thomas Wilkins"
format: html
editor: visual
---

```{r}
#| label: setup
#| echo: false
#| message: false
#| warning: false

source("functions/misc_functions.R")

load_packages(c(
  "sf",
  "dplyr",
  "ggplot2",
  "igraph"
))

# set path to geofabric data
geofab_network_path <- "data/SH_Network_GDB/"
geofab_catchments_path <- "data/HR_Catchments_GDB/"


```

## 1. Introduction

This document contains R code to extract stream and catchment geometry data for the Goulburn River and related territories.
Stream and catchment data was extracted from the Australian Hydrological Geospatial Fabric (Geofabric).

There are two layers of interest in this dataset:

1.  AHGFNetworkStream: contains stream network geometry and attributes
2.  AHGFCatchment: contains catchment geometry and attributes

### 1.1. Extracting streams connected to the Murray River outlet

Initial exploration was done to identify all streams connected to the Murray River outlet, as the Goulburn River is a tributary of the Murray River.
The most downstream point of the Murray River was identified as the Coorong Channel outlet to the Southern Ocean, near Goolwa, South Australia.

```{r}
#| label: extract_geofab_streams_data
#| echo: true
#| message: false
#| warning: false
#| results: 'hide'


st_layers(paste0(geofab_network_path, "SH_Network.gdb/"))

# read in geofabric stream network data
geofab_networkstream <- sf::st_read(
  dsn = paste0(geofab_network_path, "SH_Network.gdb/"),
  layer = "AHGFNetworkStream"
)

# Isolate most downstream point of the Murray River:
murray_ol <- geofab_networkstream[geofab_networkstream$Name == "COORONG CHANNEL" & 
                                    geofab_networkstream$NextDownID == -1, ] # -1 implies outlet
murray_ol <- murray_ol[!is.na(murray_ol$NextDownID), ] 

# Create edge list (upstream â†’ downstream)
edges <- geofab_networkstream %>%
  st_drop_geometry() %>%
  select(From_Node, To_Node, HydroID)

# Create graph object of the stream network
g <- graph_from_data_frame(edges, directed = TRUE)

# Find all upstream HydroIDs of the Murray River outlet
upstream_nodes <- subcomponent(g, as.character(murray_ol$To_Node), mode = "in")
streams_murray_connected <- geofab_networkstream %>%
  filter(From_Node %in% names(V(g))[upstream_nodes] |
         To_Node %in% names(V(g))[upstream_nodes])

# Compute shortest paths *upstream* (reverse direction)
# Add distances to streams_murray_connected
streams_murray_connected <- streams_murray_connected %>%
  mutate(distance_to_murray_ol = st_distance(Shape, st_geometry(murray_ol)))
  mutate(distance_to_murray_ol = as.numeric(distance_to_murray_ol)) # convert to numeric

streams_murray_connected$d2ol <- as.numeric(streams_murray_connected$distance_to_murray_ol)

# Identify confluences
# A confluence is where two or more upstream segments flow into a single downstream segment
# i.e., a To_Node with multiple From_Nodes
streams_murray_connected$confluence <- 0
to_node_counts <- as.data.frame(table(streams_murray_connected$To_Node))
confluence_nodes <- to_node_counts$Var1[to_node_counts$Freq > 1]
streams_murray_connected$confluence[streams_murray_connected$To_Node %in% confluence_nodes] <- 1
streams_murray_confluences <- streams_murray_connected[streams_murray_connected$confluence == 1 & 
                                                         streams_murray_connected$Name == " ", ]

# Save streams_murray_connected for later use
saveRDS(streams_murray_connected, "data/murray_networkstream.rds")

### NAMED network
streams_murray_named <- streams_murray_connected[!streams_murray_connected$Name %in% c(""," "), ]
saveRDS(streams_murray_named, "data/murray_networkstream_named.rds")


```

The following plot shows all streams connected to the Murray River outlet, overlaid on a map of Australia for verification.

```{r}
#| label: fig-plot_murray_streams
#| echo: true
#| message: false
#| warning: false
#| results: 'hide'
#| fig-cap: "Streams connected to the Murray River outlet"
#| fig-width: 8
#| fig-height: 6

# Read murray stream network data:
streams_murray_connected <- readRDS("data/murray_networkstream.rds")
streams_murray_named <- readRDS("data/murray_networkstream_named.rds")
streams_murray_unnamed <- streams_murray_connected[streams_murray_connected$Name %in% c(""," "), ]

# Extract coordinates of the most downstream point of the Murray River (murray_ol)
murray_ol <- streams_murray_connected[streams_murray_connected$Name == "COORONG CHANNEL" & 
                                    streams_murray_connected$NextDownID == -1, ]

murray_ol_geom <- st_geometry(murray_ol)[[1]]
coords <- st_coordinates(murray_ol_geom)
ds_point <- coords[nrow(coords), ]

# Convert to sf POINT
murray_ol_sf <- st_as_sf(data.frame(x = ds_point[1], y = ds_point[2]),
                       coords = c("x", "y"),
                       crs = st_crs(geofab_networkstream))


# Plot streams_murray_connected overlaid on a map of Australia to verify
australia <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
ggplot() +
  geom_sf(data = australia, fill = "lightgrey") +
  
  # Create stream lines for streams_murray_connected, with a thin line:
#  geom_sf(data = streams_murray_unnamed, color = "lightblue1", linewidth = 0.5) +
  geom_sf(data = streams_murray_named, color = "blue", linewidth = 0.5) +
  # Plot a point for the downstream-most point on the Murray River (murray_ol):
  geom_sf(data = murray_ol_sf, color = "red", size = 2) +
  coord_sf(xlim = c(138, 155), ylim = c(-40, -25)) +
  theme_minimal() +
  labs(title = "Streams connected to the Murray River outlet")


```

### 1.2. Filtering streams within the Goulburn River and Northern Tributaries (GRANT) area

For the Flow-MER project, we are interested in streams within the Goulburn River and Northern Tributaries (GRANT) area.
This area includes the Goulburn River and its major tributaries: Loddon River, Broken Creek, Broken River, and Campaspe River systems.

This area is on the lands of the Yorta Yorta and Taungurung people, Traditional Owners of the land and waters in the Goulburn and Broken catchments, and the Dja Dja Wurrung, Barapa Barapa and Wamba Wemba people, Traditional Owners of the land and waters in the Campaspe and Loddon catchments.

Flows in the rivers of the GRANT Area are highly regulated by large reservoirs, such as Lake Eildon and Lake Eppalock, and numerous smaller weirs.
Delivery of Commonwealth Environmental Water in the GRANT Area is almost entirely confined to rivers.
However, there are opportunities to deliver small volumes of water to benefit the environment in some wetlands.
The majority of environmental water is delivered to the Goulburn River, with smaller volumes delivered to the Loddon, Campaspe and Broken rivers.

The following code extracts all streams connected to the Goulburn River and its major tributaries from the Murray-connected stream network.

```{r}
#| label: fig-filter_grant_streams
#| echo: true
#| message: false
#| warning: false
#| results: 'hide'
#| fig-cap: "Streams within the Goulburn River and Northern Tributaries (GRANT) area"
#| fig-width: 8
#| fig-height: 6

streams_murray_named <- readRDS("data/murray_networkstream_named.rds")

# Identify Goulburn River segments based on known named segments
goulburn_streams <- streams_murray_named[streams_murray_named$Name %in% c("GOULBURN RIVER", "LODDON RIVER", "BROKEN CREEK", "BROKEN RIVER", "CAMPASPE RIVER"),]

# Get upstream-most segment of each stream in "GOULBURN RIVER", "LODDON RIVER", "BROKEN CREEK", "BROKEN RIVER", "CAMPASPE RIVER":
goulburn_upstream_most <- goulburn_streams %>%
  group_by(Name) %>%
  slice_max(order_by = d2ol, n = 1) %>%
  ungroup()

# find all upstream segments connected to the identified Goulburn River segment
goulburn_ig <- subcomponent(g, as.character(goulburn_upstream_most$From_Node), mode = "in")

goulburn_us <- streams_murray_named %>%
  filter(From_Node %in% names(V(g))[goulburn_ig] |
         To_Node %in% names(V(g))[goulburn_ig])

goulburn_all <- rbind(goulburn_streams, goulburn_us)

# Find unique streams based on hydroID (using base-R to avoid dplyr grouping issues):
goulburn_all <- goulburn_all[!duplicated(goulburn_all$HydroID), ]

# Names of streams in the Goulburn network:
unique(goulburn_all$Name)
GRANT_names <- as.data.frame(table(goulburn_all$Name))

# Extract Murray River segment for context in plots:
muuray_stream <- streams_murray_named[streams_murray_named$Name == "MURRAY RIVER", ]

# Plot streams_murray_connected overlaid on a map of Australia to verify
australia <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
ggplot() +
  geom_sf(data = australia, fill = "grey90") +
  geom_sf(data = muuray_stream, color = "grey40") +
  geom_sf(data = goulburn_all, color = "blue3") +
  # Plot a point for the downstream-most point on the Murray River (murray_ol):
  # geom_sf(data = murray_ol_sf, color = "red", size = 2) +
  coord_sf(xlim = c(142, 149), ylim = c(-39, -34)) +
  theme_minimal() +
  labs(title = "Streams within the Goulburn River and Northern Tributaries (GRANT) area")

saveRDS(goulburn_all, "data/goulburn_networkstream.rds")


```

There are 51 named streams within the Goulburn River and Northern Tributaries (GRANT) area, across 674 stream segments extracted from the Geofabric dataset.
Many of these streams are smaller tributaries surrounding the Lake Eildon reservoir.
The majority of stream segments (n) constitute the Goulburn River (n = 212), Loddon River (n = 107), Broken River (n = 70), Campaspe River (n = 77), and Holland (n = 28) systems.

### 1.3. Extracting catchments within the Murray-Darling Basin

To extract the catchment boundary, we read in the AHGFCatchment layer from the Geofabric dataset and filter for catchments within the Goulburn basin.

The catchment files are very large, and are best filtered at the area-scale using SQL queries when reading in the data.
Attempting to read in the entire AHGFCatchment layer may lead to memory issues if the system is not equipped to handle large datasets (e.g., \<16 GB RAM, such as a laptop or office desktop PC).

```{r}
#| label: extract_grant_catchment_data
#| echo: true
#| message: false
#| warning: false
#| results: 'hide'
#| eval: false

# Explore available layers in the geofabric geodatabase:
st_layers(paste0(geofab_network_path, "SH_Network.gdb/"))

# Inspect field names in AHGFCatchment layer
cat_head <- st_read(
  dsn = paste0(geofab_network_path, "SH_Network.gdb/"),
  layer = "AHGFCatchment",
  query = "SELECT * FROM AHGFCatchment LIMIT 5"
)

# names(cat_head)
# Column headers of interest:
# [1] "AHGFCatchmentID"      "AHGFCatchmentName"    "HydroID"

# Read in GRANT streams to get list of catchment names:
goulburn_networkstream <- readRDS("data/goulburn_networkstream.rds")

# read in geofabric catchment data for the goulburn basin:
cat_sf <- sf::st_read(
  dsn = paste0(geofab_network_path, "SH_Network.gdb/"),
  layer = "AHGFCatchment",
  query = paste0("SELECT * FROM AHGFCatchment WHERE AHGFCatchmentName IN ", unique(goulburn_networkstream$Name))
)



```
